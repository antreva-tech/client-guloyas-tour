// Guloyas Tours — Operations database (tours + bookings + WhatsApp)
// Database: Neon Postgres
//
// Domain semantics: Tour = tour/excursion; Sale = booking/reservation line (batchId = invoice).
// AdminSettings.lowStockThreshold = default low-seats threshold when Tour.lowSeatsThreshold is null.

generator client {
  provider = "prisma-client-js"
}

// directUrl for migrations is supplied by prisma.config.ts (derived from DATABASE_URL for Neon)
datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
}

/// Tour/excursion in the catalog. stock = seats/capacity, sold = booked.
model Tour {
  id                String   @id @default(cuid())
  name              String
  line              String   @default("Tour") /// Category label (e.g. tour type)
  description       String
  price             Int      /// Adult price (Precio Adultos)
  childPrice        Int?     /// Optional children price (Precio Niños)
  currency          String   @default("RD$")
  imageUrls         String[] @default([]) /// Multiple tour images (swipeable on card)
  stock             Int      @default(0)   /// Seats/capacity
  sold              Int      @default(0)   /// Booked count
  isActive          Boolean  @default(true)
  sequence          Int      @default(0)   /// Display order in catalog (lower = first)
  lowSeatsThreshold Int?     /// Per-tour threshold for "low seats" badge (null = use default)
  tourDate          DateTime? /// Default date; pre-fills "Fecha del Tour" when booking
  recurringWeeklyDay Int?    /// 0=Sunday..6=Saturday; when set, tour runs weekly and seats reset after that day
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  sales             Sale[]

  @@index([isActive, createdAt])
  @@map("tours")
}

/// Booking/reservation line (one row per tour/quantity); batchId groups lines into one invoice.
model Sale {
  id               String    @id @default(cuid())
  batchId          String    @default(cuid())
  tourId           String
  quantity         Int
  total            Int
  abono            Int?      /// Partial payment amount ($)
  pendiente        Int?      /// Pending amount ($)
  customerName     String?
  customerPhone    String?
  cedula           String?
  provincia        String?
  municipio        String?
  customerAddress  String?
  personasAdditional Json?   /// Additional people in reservation: [{ type, name, dateOfBirth, cedulaPassport, phone? }]
  notes            String?
  fechaEntrega     DateTime?
  fechaVisita      DateTime? /// Tour date (required via API; may be sourced from Tour.tourDate)
  fechaLimitePago  DateTime? /// Payment deadline (Fecha límite de pago)
  supervisor       String?
  nombreVendedor   String?
  isPaid           Boolean   @default(false)
  voidedAt         DateTime?
  voidReason       String?
  createdAt        DateTime  @default(now())
  tour             Tour      @relation(fields: [tourId], references: [id])

  @@index([createdAt])
  @@index([batchId])
  @@index([tourId])
  @@index([supervisor])
  @@index([isPaid])
  @@map("sales")
}

/// Monthly revenue/bookings snapshot for historical tracking
model MonthlySummary {
  id             String   @id @default(cuid())
  year           Int
  month          Int
  totalRevenue   Int
  totalSold      Int
  totalTours      Int
  topTourId      String?
  topTourSold    Int      @default(0)
  createdAt      DateTime @default(now())

  @@unique([year, month])
  @@map("monthly_summaries")
}

/// Supervisor, admin, and support users. Admin/support are env-based; only supervisors in DB.
model User {
  id                 String   @id @default(cuid())
  username           String   @unique
  passwordHash       String
  role               String   /// "supervisor" only (admin/support are env-based)
  supervisorName     String?  /// For supervisors: matches Sale.supervisor (e.g. tour/sales supervisor)
  isActive           Boolean  @default(true)
  mustChangePassword Boolean  @default(true) // Admin sets temp password; user must change on first login
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@index([username, isActive])
  @@index([role])
  @@map("users")
}

/// Single admin credential for dashboard access
model AdminCredential {
  id           String   @id
  passwordHash String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("admin_credentials")
}

/// Seller/guide name options for booking form. Admin manages in Ajustes.
model Seller {
  id        String   @id @default(cuid())
  name      String   @unique
  createdAt DateTime @default(now())

  @@map("sellers")
}

/// Admin settings. lowStockThreshold = default low-seats threshold when Tour.lowSeatsThreshold is null.
model AdminSettings {
  id                 String   @id @default("default")
  lowStockThreshold  Int      @default(5)  /// Default low-seats threshold for tours
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@map("admin_settings")
}

/// WhatsApp message log for dashboard interactions and status tracking
model WhatsAppMessageLog {
  id             String   @id @default(cuid())
  direction      String   /// "outbound" | "inbound"
  externalId     String?
  batchId        String?
  tourId         String?
  customerPhone  String
  body           String?
  status         String   /// "sent" | "delivered" | "read" | "failed"
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([batchId])
  @@index([tourId])
  @@index([customerPhone])
  @@index([createdAt])
  @@map("whatsapp_message_log")
}
