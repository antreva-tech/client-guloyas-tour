// Guloyas Tours â€” Operations database (tours + bookings + WhatsApp)
// Database: Neon Postgres
//
// Domain semantics (see docs/ and plan):
// - Product = tour/excursion; stock = seats/capacity, sold = booked (column names kept for compatibility).
// - Sale = booking/reservation line; batchId groups lines into one invoice.
// - AdminSettings.lowStockThreshold = default low-seats threshold when Product.lowSeatsThreshold is null.

generator client {
  provider = "prisma-client-js"
}

// directUrl for migrations is supplied by prisma.config.ts (derived from DATABASE_URL for Neon)
datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
}

/// Tour or excursion in the catalog (table name "products" kept for compatibility).
/// Semantics: stock = seats/capacity, sold = booked.
model Product {
  id          String   @id @default(cuid())
  name        String
  line        String   /// Product line/category (e.g. tour type)
  description String
  price       Int
  specialOfferPrice Int?  /// Optional special price; shown in booking dropdown when set
  currency    String   @default("RD$")
  imageUrl    String?
  stock       Int      @default(0)   /// Seats/capacity
  sold        Int      @default(0)   /// Booked count
  isActive    Boolean  @default(true)
  sequence    Int      @default(0)   /// Display order in catalog (lower = first)
  lowSeatsThreshold Int?  /// Per-tour threshold for "low seats" badge (null = use default or hide)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  sales       Sale[]

  /// Index for active products sorted by creation date (catalog queries)
  @@index([isActive, createdAt])
  @@map("products")
}

/// Booking/reservation line (one row per tour/quantity); batchId groups lines into one invoice.
/// New fields are nullable in DB for backward compatibility; API validation requires them for new bookings.
model Sale {
  id              String    @id @default(cuid())
  batchId         String    @default(cuid())
  productId       String
  quantity        Int
  total           Int
  abono           Int?      /// Partial payment amount ($)
  pendiente       Int?      /// Pending amount ($)
  customerName    String?   /// Customer name (required via API)
  customerPhone   String?   /// Phone (required via API)
  cedula          String?   /// Cedula/ID number (required via API)
  provincia       String?   /// Province (required via API, dropdown)
  municipio       String?   /// Municipality (required via API, free-form text)
  customerAddress String?   /// Optional address (Direccion)
  lugarTrabajo    String?   /// Workplace (required via API)
  notes           String?   /// Optional referencia/nota
  fechaEntrega    DateTime? /// Delivery date (required via API)
  fechaVisita     DateTime? /// Visit date (required via API)
  supervisor      String?   /// Supervisor (required via API)
  nombreVendedor  String?   /// Seller name (required via API)
  isPaid          Boolean   @default(false) /// Payment status flag
  voidedAt        DateTime?
  voidReason      String?
  createdAt       DateTime  @default(now())
  product         Product   @relation(fields: [productId], references: [id])

  /// Index for date-based booking queries
  @@index([createdAt])
  /// Index for batch lookup (void operations)
  @@index([batchId])
  /// Index for product-based booking queries
  @@index([productId])
  /// Index for supervisor filtering
  @@index([supervisor])
  /// Index for payment status filtering
  @@index([isPaid])
  @@map("sales")
}

/// Monthly revenue/bookings snapshot for historical tracking
model MonthlySummary {
  id            String   @id @default(cuid())
  year          Int
  month         Int
  totalRevenue  Int
  totalSold     Int
  totalProducts Int
  topProductId  String?
  topProductSold Int     @default(0)
  createdAt     DateTime @default(now())

  @@unique([year, month])
  @@map("monthly_summaries")
}

/// Supervisor, admin, and support users. Admin/support are env-based; only supervisors in DB.
model User {
  id                 String   @id @default(cuid())
  username           String   @unique
  passwordHash       String
  role               String   /// "supervisor" only (admin/support are env-based)
  supervisorName     String?  /// For supervisors: matches Sale.supervisor (e.g. tour/sales supervisor)
  isActive           Boolean  @default(true)
  mustChangePassword Boolean  @default(true) // Admin sets temp password; user must change on first login
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@index([username, isActive])
  @@index([role])
  @@map("users")
}

/// Single admin credential for dashboard access
model AdminCredential {
  id           String   @id
  passwordHash String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("admin_credentials")
}

/// Seller/guide name options for booking form. Admin manages in Ajustes.
model Seller {
  id        String   @id @default(cuid())
  name      String   @unique
  createdAt DateTime @default(now())

  @@map("sellers")
}

/// Admin settings for dashboard. lowStockThreshold = default low-seats threshold when Product.lowSeatsThreshold is null (UI: "Umbral de plazas bajas (por defecto)").
model AdminSettings {
  id                 String   @id @default("default")
  lowStockThreshold  Int      @default(5)  /// Default low-seats threshold for tours
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@map("admin_settings")
}

/// WhatsApp message log for dashboard interactions and status tracking
model WhatsAppMessageLog {
  id             String   @id @default(cuid())
  direction      String   /// "outbound" | "inbound"
  externalId     String?  /// Meta message ID
  batchId        String?
  productId      String?
  customerPhone  String
  body           String?  /// Message text or template name
  status         String   /// "sent" | "delivered" | "read" | "failed"
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([batchId])
  @@index([productId])
  @@index([customerPhone])
  @@index([createdAt])
  @@map("whatsapp_message_log")
}
